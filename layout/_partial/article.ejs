<div class="content">
  <article id="<%= post.layout %>-<%= post.slug %>" class="article article-type-<%= post.layout %>" itemscope itemtype="http://schema.org/BlogPosting">
    <%- partial('post/gallery') %>
    
    <%
      // 图片处理函数 - 只获取最重要的一张图片
      const getArticleImage = (post) => {
        // 处理图片URL的辅助函数
        const normalizeImageUrl = (url) => {
          if (!url) return '';
          // 处理完整的URL
          if (url.startsWith('http')) {
            return url;
          }
          // 处理相对路径
          return `${config.url}${url.startsWith('/') ? '' : '/'}${url}`;
        };

        // 优先级：1.封面图 2.文章第一张图 3.默认logo
        if (post.cover) {
          return normalizeImageUrl(post.cover);
        }

        // 提取文章中的第一张图片
        const imgReg = /<img.*?src="(.*?)".*?>/;
        const match = post.content.match(imgReg);
        if (match) {
          return normalizeImageUrl(match[1]);
        }

        // 默认返回网站logo
        return normalizeImageUrl('/favicon.png');
      };

      // 关键词处理函数 - 优化提取逻辑
      const generateKeywords = (post) => {
        const keywordSet = new Set();
        
        // 1. 使用显式定义的关键词（最高优先级）
        if (post.keywords && Array.isArray(post.keywords)) {
          post.keywords.forEach(kw => keywordSet.add(kw.trim()));
        }
        
        // 2. 使用标签（第二优先级）
        if (post.tags) {
          post.tags.forEach(tag => keywordSet.add(tag.name.trim()));
        }

        // 3. 使用分类（如果有）
        if (post.categories) {
          post.categories.forEach(cat => keywordSet.add(cat.name.trim()));
        }

        // 4. 从标题提取主要关键词（移除分隔符和网站名称）
        const mainTitle = post.title
          .replace(/[|｜].*$/, '')  // 移除网站名称部分
          .trim();
        keywordSet.add(mainTitle);  // 添加完整标题作为关键词

        // 5. 确保关键词质量
        const keywords = Array.from(keywordSet)
          .filter(keyword => 
            keyword.length >= 2 &&  // 关键词至少2个字符
            keyword.length <= 50 && // 关键词不超过50个字符
            !/^[的了和与在是]+$/.test(keyword) // 排除无意义词
          )
          .slice(0, 8);  // 限制关键词数量，建议5-8个

        return keywords;
      };
    %>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "<%- config.url %><%- url_for(post.path) %>"
      },
      "headline": "<%- post.title.replace(/[|｜].*$/, '').trim() %>",
      "description": "<%- post.description %>",
      "datePublished": "<%- post.date.toISOString() %>",
      "dateModified": "<%- post.updated ? post.updated.toISOString() : post.date.toISOString() %>",
      "author": {
        "@type": "Person",
        "name": "<%- config.author %>",
        "url": "<%- config.url %>",
        "alternateName": "良技漫谈"
      },
      "image": "<%- getArticleImage(post) %>",
      "keywords": <%- JSON.stringify(generateKeywords(post)) %>,
      "publisher": {
        "@type": "Organization",
        "name": "良技漫谈",
        "logo": {
          "@type": "ImageObject",
          "url": "<%- config.url %>/favicon.png",
          "width": "60",
          "height": "60"
        }
      }
    }
    </script>

    <div class="article-header">
      <% if (post.link || post.title){ %>
        <%- partial('post/title', {class_name: 'article-title'}) %>
      <% } %>
      <div class="article-meta">
        <%- partial('post/date', {class_name: 'article-date', date_format: null}) %>
        <%- partial('post/category') %>
        <%- partial('post/tag') %>
        <%- partial('post/pv') %>
        <span class="post-comment"><i class="icon icon-comment"></i> <a href="<%- url_for(post.path) %>#comments" class="article-comment-link"><%= __('article.comments') %></a></span>
        <%- partial('post/wordcount') %>
      </div>
    </div>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7730278451516700"
     crossorigin="anonymous"></script>
<!-- title -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-7730278451516700"
     data-ad-slot="3100240204"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script> 
    
    <div class="article-entry marked-body" itemprop="articleBody">
      <% if (post.excerpt && index){ %>
        <%- post.excerpt %>
        <% if (theme.config.excerpt_link){ %>
          <p class="article-more-link">
            <a href="<%- url_for(post.path) %>#more"><%= theme.config.excerpt_link %></a>
          </p>
        <% } %>
      <% } else { %>
        <%- post.content %>
      <% } %>
    </div>
    <div class="article-footer">
      <%- partial('post/copyright') %>
    </div>
  </article>
  <% if (!index) { %>
    <%- partial('post/comment') %>
  <% } %>
</div>
<% if (!index){ %>
  <%- partial('post/nav') %>
  <%- partial('post/donate') %>
<% } %>
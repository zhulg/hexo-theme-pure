<div class="content">
  <article id="<%= post.layout %>-<%= post.slug %>" class="article article-type-<%= post.layout %>" itemscope itemtype="http://schema.org/BlogPosting">
    <%- partial('post/gallery') %>
    
    <%
      // 图片处理函数 - 只获取最重要的一张图片
      const getArticleImage = (post) => {
        // 处理图片URL的辅助函数
        const normalizeImageUrl = (url) => {
          if (!url) return `${config.url}/favicon.png`;  // 默认返回favicon
          if (url.startsWith('http')) return url;
          return `${config.url}${url.startsWith('/') ? '' : '/'}${url}`;
        };

        // 如果不是文章页面，直接返回默认图片
        if (!post || !post.layout || post.layout !== 'post') {
          return normalizeImageUrl(theme.site.logo.url || '/favicon.png');
        }

        // 优先级：1.封面图 2.文章第一张图 3.默认logo
        if (post.cover) {
          return normalizeImageUrl(post.cover);
        }

        // 提取文章中的第一张图片
        if (post.content) {
          const imgReg = /<img.*?src="(.*?)".*?>/;
          const match = post.content.match(imgReg);
          if (match) {
            return normalizeImageUrl(match[1]);
          }
        }

        // 默认返回网站logo
        return normalizeImageUrl('/favicon.png');
      };

      // 关键词处理函数 - 优化提取逻辑
      const generateKeywords = (post) => {
        const keywordSet = new Set();
        
        // 如果不是文章页面，返回网站默认关键词
        if (!post || !post.layout || post.layout !== 'post') {
          return config.keywords ? config.keywords.split(',').map(k => k.trim()) : [];
        }

        // 1. 使用显式定义的关键词
        if (post.keywords && Array.isArray(post.keywords)) {
          post.keywords.forEach(kw => keywordSet.add(kw.trim()));
        }
        
        // 2. 使用标签
        if (post.tags) {
          post.tags.forEach(tag => keywordSet.add(tag.name.trim()));
        }

        // 3. 从标题提取关键词
        if (post.title) {
          const mainTitle = post.title.replace(/[|｜].*$/, '').trim();
          keywordSet.add(mainTitle);
        }

        return Array.from(keywordSet);
      };

      // 检查是否为文章页面
      const isPost = post && post.layout === 'post';
      
      // 获取日期，如果不存在则使用当前时间
      const publishDate = post.date ? post.date.toISOString() : new Date().toISOString();
      const modifiedDate = (post.updated || post.date || new Date()).toISOString();
    %>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "<%- config.url %><%- url_for(post.path) %>"
      },
      "headline": "<%- post.title ? post.title.replace(/[|｜].*$/, '').trim() : config.title %>",
      "description": "<%- post.description || config.description %>",
      "datePublished": "<%- publishDate %>",
      "dateModified": "<%- modifiedDate %>",
      "author": {
        "@type": "Person",
        "name": "<%- config.author %>",
        "url": "<%- config.url %>",
        "alternateName": "良技漫谈"
      },
      "image": "<%- getArticleImage(post) %>",
      "keywords": <%- JSON.stringify(generateKeywords(post)) %>,
      "publisher": {
        "@type": "Organization",
        "name": "良技漫谈",
        "logo": {
          "@type": "ImageObject",
          "url": "<%- config.url %>/favicon.png",
          "width": "60",
          "height": "60"
        }
      }
    }
    </script>

    <div class="article-header">
      <% if (post.link || post.title){ %>
        <%- partial('post/title', {class_name: 'article-title'}) %>
      <% } %>
      <div class="article-meta">
        <%- partial('post/date', {class_name: 'article-date', date_format: null}) %>
        <%- partial('post/category') %>
        <%- partial('post/tag') %>
        <%- partial('post/pv') %>
        <span class="post-comment"><i class="icon icon-comment"></i> <a href="<%- url_for(post.path) %>#comments" class="article-comment-link"><%= __('article.comments') %></a></span>
        <%- partial('post/wordcount') %>
      </div>
    </div>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7730278451516700"
     crossorigin="anonymous"></script>
<!-- title -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-7730278451516700"
     data-ad-slot="3100240204"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script> 
    
    <div class="article-entry marked-body" itemprop="articleBody">
      <% if (post.excerpt && index){ %>
        <%- post.excerpt %>
        <% if (theme.config.excerpt_link){ %>
          <p class="article-more-link">
            <a href="<%- url_for(post.path) %>#more"><%= theme.config.excerpt_link %></a>
          </p>
        <% } %>
      <% } else { %>
        <%- post.content %>
      <% } %>
    </div>
    <div class="article-footer">
      <%- partial('post/copyright') %>
    </div>
  </article>
  <% if (!index) { %>
    <%- partial('post/comment') %>
  <% } %>
</div>
<% if (!index){ %>
  <%- partial('post/nav') %>
  <%- partial('post/donate') %>
<% } %>